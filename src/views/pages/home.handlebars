<style>
  .home-container{background:#2d2d2d;border-radius:12px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,.3)}
  .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;padding-bottom:18px;border-bottom:2px solid #404040}
  .page-title{font-size:1.8rem;color:#e5e5e5;display:flex;align-items:center;gap:12px}
  .product-count{background:#dc2626;color:#fff;padding:8px 20px;border-radius:50px;font-weight:600;font-size:.9rem}
  
  /* Filtros */
  .filters{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;border:1px solid #404040;background:#1a1a1a;color:#e5e5e5;font-weight:700;font-size:.9rem;text-decoration:none;transition:.2s}
  .chip:hover{border-color:#dc2626;transform:translateY(-1px)}
  .chip .dot{display:inline-block;width:8px;height:8px;border-radius:999px;background:#404040}
  .chip.active{background:#dc2626;border-color:#dc2626;color:#fff}
  .chip.active .dot{background:#fff}
  .chip.total{margin-right:8px}
  .chip.badge{position:relative}
  .chip .count{background:#404040;color:#a3a3a3;border-radius:6px;font-size:.75rem;padding:2px 6px}
  
  /* CategorÃ­as y tarjetas */
  .cat-block{margin-top:22px}
  .cat-title{display:flex;align-items:center;gap:10px;color:#e5e5e5;font-size:1.2rem;margin-bottom:14px}
  .cat-badge{font-size:.75rem;background:#dc2626;color:#fff;border-radius:999px;padding:4px 10px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  @media (max-width:1200px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
  
  .card{
    background:#1a1a1a;
    border:1px solid #404040;
    border-radius:10px;
    padding:18px;
    position:relative;
    overflow:hidden;
    transition:.25s;
    display:flex;
    flex-direction:column;
    min-height:420px;
  }
  .card::before{content:'';position:absolute;inset:auto auto 0 0;height:3px;width:100%;background:#dc2626;opacity:.8}
  .card:hover{transform:translateY(-2px);border-color:#dc2626;box-shadow:0 5px 20px rgba(220,38,38,.2)}
  
  /* Header de card */
  .card-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    margin-bottom:12px;
    flex-shrink:0;
  }
  
  /* ID completo sin truncar */
  .pid{
    background:#404040;
    color:#a3a3a3;
    padding:4px 8px;
    border-radius:4px;
    font-size:.7rem;
    font-family:monospace;
    max-width:none;
    overflow:visible;
    text-overflow:clip;
    white-space:nowrap;
  }
  
  /* Contenido de card */
  .card-content{
    flex:1;
    display:flex;
    flex-direction:column;
  }
  
  /* Footer de card */
  .card-footer{
    margin-top:auto;
    padding-top:12px;
    border-top:1px solid #404040;
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-shrink:0;
  }
  
  .cat{background:#dc2626;color:#fff;padding:3px 8px;border-radius:4px;font-size:.7rem;font-weight:700;text-transform:uppercase}
  
  /* Imagen */
  .thumb{
    width:100%;
    aspect-ratio:16/9;
    background:#ffffff;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    margin:10px 0 12px;
    overflow:hidden;
    border:1px solid #e5e5e5;
  }
  .thumb img{width:100%;height:100%;object-fit:contain;padding:0}
  .thumb > div {background:transparent !important}
  
  .title{font-size:1.05rem;color:#e5e5e5;font-weight:800;margin:6px 0 4px}
  .desc{color:#a3a3a3;font-size:.9rem;line-height:1.5;margin-bottom:12px}
  
  .specs{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:auto;
    padding:10px;
    background:#0d0d0d;
    border-radius:6px;
    border:1px solid #2e2e2e;
  }
  .spec{display:inline-flex;gap:4px;align-items:center;background:#1a1a1a;border:1px solid #404040;border-radius:6px;padding:5px 8px;color:#e5e5e5;font-size:.8rem}
  .spec strong{color:#dc2626;font-weight:600}
  
  .price{color:#dc2626;font-weight:900;font-size:1.2rem}
  .stock{background:#1a1a1a;border:1px solid #404040;color:#e5e5e5;padding:6px 10px;border-radius:8px;font-weight:700;font-size:.85rem}
  .stock.low{border-color:#dc2626;color:#dc2626}
  .stock.out{background:#dc2626;color:#fff;border-color:#dc2626}
  .empty{margin:12px 0;background:#1a1a1a;border:1px solid #404040;border-radius:10px;padding:28px;color:#737373;text-align:center}
  .empty-global{margin:40px 0;background:#1a1a1a;border:1px solid #404040;border-radius:10px;padding:50px;color:#737373;text-align:center}
  .action-section{text-align:center;margin-top:34px;padding-top:24px;border-top:1px solid #404040}
  .btn{display:inline-block;background:#dc2626;color:#fff;padding:14px 30px;border-radius:8px;text-decoration:none;font-weight:700;transition:.25s;box-shadow:0 4px 15px rgba(220,38,38,.3)}
  .btn:hover{background:#b91c1c;transform:translateY(-2px);box-shadow:0 6px 20px rgba(220,38,38,.4)}

  /* PaginaciÃ³n */
  .pagination {display:flex;justify-content:center;gap:12px;margin-top:28px}
  .pagination a, .pagination span {padding:10px 16px;border-radius:8px;font-weight:700;text-decoration:none}
  .pagination a {background:#1a1a1a;border:1px solid #404040;color:#e5e5e5;transition:.2s}
  .pagination a:hover {border-color:#dc2626;color:#fff;background:#dc2626}
  .pagination span {background:#dc2626;border:1px solid #dc2626;color:#fff}
</style>

<div class="home-container">
  <div class="page-header">
    <h1 class="page-title"><span>ðŸ“¦</span> CatÃ¡logo de Productos</h1>
    {{#if totalDocs}}
      <span class="product-count">{{totalDocs}} productos totales</span>
    {{/if}}
  </div>

  {{!-- ====== FILTROS (siempre visibles) ====== --}}
  <div class="filters">
    <a href="/" class="chip total {{#unless currentCategory}}active{{/unless}}">
      <span class="dot"></span> Todos
      <span class="count">{{totalDocs}}</span>
    </a>
    <a href="/?category=replicas" class="chip {{#if (eq currentCategory 'replicas')}}active{{/if}}">
      <span class="dot"></span> RÃ©plicas
      <span class="count">{{replicasCount}}</span>
    </a>
    <a href="/?category=magazines" class="chip {{#if (eq currentCategory 'magazines')}}active{{/if}}">
      <span class="dot"></span> Cargadores
      <span class="count">{{magazinesCount}}</span>
    </a>
    <a href="/?category=bbs" class="chip {{#if (eq currentCategory 'bbs')}}active{{/if}}">
      <span class="dot"></span> BBs
      <span class="count">{{bbsCount}}</span>
    </a>
    <a href="/?category=batteries" class="chip {{#if (eq currentCategory 'batteries')}}active{{/if}}">
      <span class="dot"></span> BaterÃ­as
      <span class="count">{{batteriesCount}}</span>
    </a>
  </div>

  {{!-- Si NO hay productos en absoluto --}}
  {{#unless hasAnyProducts}}
    <div class="empty-global">
      <h3>No hay productos disponibles</h3>
      <p>AÃºn no se han agregado productos al catÃ¡logo</p>
    </div>
  {{else}}
    {{!-- Si hay filtro de categorÃ­a activo --}}
    {{#if currentCategory}}
      <section class="cat-block">
        <h2 class="cat-title">
          {{currentCategoryTitle}} 
          <span class="cat-badge">{{#if payload}}{{payload.length}}{{else}}0{{/if}}</span>
        </h2>
        {{#if payload}}
          <div class="grid">
            {{#each payload}}
              <article class="card">
                <div class="card-header">
                  <span class="pid">ID: {{_id}}</span>
                  <span class="cat">{{category}}</span>
                </div>

                <div class="card-content">
                  <div class="thumb">
                    {{#if thumbnails.[0]}}
                      <img src="{{thumbnails.[0]}}" alt="{{title}}">
                    {{else}} 
                      <div style="font-size:2.2rem;color:#525252">ðŸŽ¯</div>
                    {{/if}}
                  </div>

                  <h3 class="title">{{title}}</h3>
                  <p class="desc">{{#if description}}{{description}}{{else}}Sin descripciÃ³n{{/if}}</p>

                  {{#if specs}}
                    <div class="specs">
                      {{#each specs}}
                        <span class="spec"><strong>{{@key}}:</strong> {{this}}</span>
                      {{/each}}
                    </div>
                  {{/if}}
                </div>

                <div class="card-footer">
                  <span class="price">${{price}}</span>
                  <span class="stock {{#if (eq stock 0)}}out{{else}}{{#if (lte stock 10)}}low{{/if}}{{/if}}">
                    Stock: {{stock}}
                  </span>
                </div>
              </article>
            {{/each}}
          </div>
        {{else}}
          <div class="empty">No hay productos en esta categorÃ­a.</div>
        {{/if}}
      </section>

    {{else}}
      {{!-- Vista de TODAS las categorÃ­as (sin filtro) --}}
      {{#if groupedProducts}}
        {{#each groupedProducts}}
          <section class="cat-block">
            <h2 class="cat-title">
              {{this.title}} <span class="cat-badge">{{this.items.length}}</span>
            </h2>

            {{#if this.items.length}}
              <div class="grid">
                {{#each this.items}}
                  <article class="card">
                    <div class="card-header">
                      <span class="pid">ID: {{_id}}</span>
                      <span class="cat">{{../badge}}</span>
                    </div>

                    <div class="card-content">
                      <div class="thumb">
                        {{#if thumbnails.[0]}}
                          <img src="{{thumbnails.[0]}}" alt="{{title}}">
                        {{else}} 
                          <div style="font-size:2.2rem;color:#525252">ðŸŽ¯</div>
                        {{/if}}
                      </div>

                      <h3 class="title">{{title}}</h3>
                      <p class="desc">{{#if description}}{{description}}{{else}}Sin descripciÃ³n{{/if}}</p>

                      {{#if specs}}
                        <div class="specs">
                          {{#each specs}}
                            <span class="spec"><strong>{{@key}}:</strong> {{this}}</span>
                          {{/each}}
                        </div>
                      {{/if}}
                    </div>

                    <div class="card-footer">
                      <span class="price">${{price}}</span>
                      <span class="stock {{#if (eq stock 0)}}out{{else}}{{#if (lte stock 10)}}low{{/if}}{{/if}}">
                        Stock: {{stock}}
                      </span>
                    </div>
                  </article>
                {{/each}}
              </div>
            {{else}}
              <div class="empty">No hay productos en esta categorÃ­a.</div>
            {{/if}}
          </section>
        {{/each}}
      {{/if}}
    {{/if}}

    {{!-- PaginaciÃ³n (solo si hay productos) --}}
    {{#if payload}}
      <div class="pagination">
        {{#if hasPrevPage}}
          <a href="{{prevLink}}">Â« Anterior</a>
        {{/if}}

        <span>PÃ¡gina {{page}} / {{totalPages}}</span>

        {{#if hasNextPage}}
          <a href="{{nextLink}}">Siguiente Â»</a>
        {{/if}}
      </div>
    {{/if}}
  {{/unless}}

  <div class="action-section">
    <p style="color:#737373;margin-bottom:20px">Â¿QuerÃ©s gestionarlos en tiempo real?</p>
    <a href="/realtimeproducts" class="btn">âš¡ Ir a Vista en Tiempo Real</a>
  </div>
</div>